<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Amortization Calculator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { margin-bottom: 10px; color: #333; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fafafa;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
        }
        .section h2 { margin-bottom: 15px; color: #333; font-size: 18px; }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            font-family: monospace;
            resize: vertical;
            min-height: 100px;
        }
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 12px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 13px;
            color: #1565C0;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { background: #45a049; }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover { background: #1976D2; }
        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            color: #e65100;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .results {
            margin-top: 30px;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .metric-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        .metric-sub {
            font-size: 14px;
            color: #4CAF50;
            margin-top: 5px;
        }
        .metric-sub.negative {
            color: #f44336;
        }
        canvas {
            width: 100% !important;
            height: 400px !important;
            margin: 20px 0;
        }
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }
        tr:hover { background: #fafafa; }
        tr.fy-band {
            background: #f0f7ff !important;
        }
        tr.current-month {
            background: #fff3e0 !important;
            font-weight: 600;
        }
        .fy-header {
            background: #e3f2fd !important;
            font-weight: bold;
            color: #1565C0;
        }
        .toggle-section {
            margin: 20px 0;
        }
        .scenario-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .scenario-btn {
            background: #e0e0e0;
            color: #333;
            padding: 10px 20px;
            font-size: 14px;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .scenario-btn:hover {
            background: #d0d0d0;
        }
        .scenario-btn.active {
            background: #2196F3;
            color: white;
            border-color: #1976D2;
        }
        .download-section {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 6px;
        }
        .download-section h3 {
            margin-bottom: 10px;
        }
        .hidden { display: none; }
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .two-col { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Loan Amortization Calculator</h1>
        <p class="subtitle">Bank-accurate EMI modeling with prepayments and rate changes</p>

        <div class="section">
            <h2>Base Loan Details</h2>
            <div class="two-col">
                <div class="input-group">
                    <label for="loanStartDate">Loan Start Date</label>
                    <input type="text" id="loanStartDate" placeholder="YYYY-MM-DD" value="2022-05-11">
                </div>
                <div class="input-group">
                    <label for="firstEmiDate">First EMI Date</label>
                    <input type="text" id="firstEmiDate" placeholder="YYYY-MM-DD" value="2022-06-10">
                </div>
            </div>
            <div class="two-col">
                <div class="input-group">
                    <label for="loanAmount">Loan Amount</label>
                    <input type="number" id="loanAmount" value="5000000" step="10000">
                </div>
                <div class="input-group">
                    <label for="annualRate">Annual Interest Rate (%)</label>
                    <input type="number" id="annualRate" value="8.5" step="0.1">
                </div>
            </div>
            <div class="input-group">
                <label for="tenureYears">Tenure (Years)</label>
                <input type="number" id="tenureYears" value="20" step="1">
            </div>
        </div>

        <div class="section">
            <h2>Adjustment Strategy</h2>
            <div class="input-group">
                <label for="adjustmentMode">When Interest Rate or Prepayment Changes</label>
                <select id="adjustmentMode">
                    <option value="recalculate">Recalculate EMI (Keep Tenure Fixed)</option>
                    <option value="keep_emi">Keep EMI Same (Tenure May Change)</option>
                </select>
                <div class="info-box">
                    <strong>Recalculate EMI:</strong> EMI adjusts to maintain original tenure. Higher rates = higher EMI, prepayments = lower EMI.<br>
                    <strong>Keep EMI Same:</strong> EMI stays constant. Higher rates = longer tenure, prepayments = shorter tenure.
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Interest Rate Changes (Optional)</h2>
            <div class="input-group">
                <label for="rateChanges">Rate Changes</label>
                <textarea id="rateChanges" placeholder="YYYY-MM-DD,new_rate_percent
2025-06-15,9.0
2026-01-15,8.0"></textarea>
                <div class="help-text">Format: YYYY-MM-DD,rate (one per line)</div>
            </div>
        </div>

        <div class="section">
            <h2>Prepayments (Optional)</h2>
            <div class="input-group">
                <label for="prepayments">Prepayments</label>
                <textarea id="prepayments" placeholder="YYYY-MM-DD,prepayment_amount,simple_interest_on_prepayment
2025-12-15,200000,0
2027-06-15,150000,5000"></textarea>
                <div class="help-text">Format: YYYY-MM-DD,amount,simple_interest (one per line). Simple interest is added to total interest paid.</div>
            </div>
        </div>

        <button onclick="calculate()">Calculate</button>

        <div id="errors"></div>
        <div id="warnings"></div>
        <div id="results" class="results hidden"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // ========== CORE DATA STRUCTURES ==========
        
        function parseDate(str) {
            const parts = str.split('-');
            if (parts.length !== 3) throw new Error(`Invalid date format: ${str}`);
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            const d = new Date(year, month, day);
            if (isNaN(d.getTime())) throw new Error(`Invalid date: ${str}`);
            return d;
        }

        function formatDate(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function addMonths(date, months) {
            const d = new Date(date);
            const targetMonth = d.getMonth() + months;
            const targetYear = d.getFullYear() + Math.floor(targetMonth / 12);
            const newMonth = targetMonth % 12;
            const originalDay = d.getDate();
            const result = new Date(targetYear, newMonth, originalDay);
            if (result.getDate() !== originalDay) {
                result.setDate(0);
            }
            return result;
        }

        function addDays(date, days) {
            const d = new Date(date);
            d.setDate(d.getDate() + days);
            return d;
        }

        function getFinancialYear(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            if (month >= 3) { // April (3) to March (2)
                return `FY ${year}-${(year + 1) % 100}`;
            } else {
                return `FY ${year - 1}-${year % 100}`;
            }
        }

        function isSameMonth(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() && 
                   date1.getMonth() === date2.getMonth();
        }

        // ========== EMI CALENDAR ==========
        
        function buildEmiCalendar(loanStartDate, firstEmiDate, totalMonths) {
            const calendar = [];
            let cycleStart = loanStartDate;
            
            for (let i = 0; i < totalMonths; i++) {
                const emiDate = addMonths(firstEmiDate, i);
                
                calendar.push({
                    index: i + 1,
                    cycleStart: new Date(cycleStart),
                    emiDate: emiDate
                });
                
                cycleStart = addDays(emiDate, 1);
            }
            
            return calendar;
        }

        // ========== EVENT MAPPING ==========
        
        function mapEventToCycle(eventDate, calendar) {
            for (let cycle of calendar) {
                // Event maps to cycle if: cycleStart <= eventDate <= emiDate
                if (eventDate >= cycle.cycleStart && eventDate <= cycle.emiDate) {
                    return cycle.index;
                }
            }
            return null;
        }

        // ========== EMI CALCULATION ==========
        
        function calculateEmi(principal, annualRate, months) {
            if (months <= 0 || principal <= 0) return 0;
            const r = annualRate / 12 / 100;
            if (r === 0) return principal / months;
            const power = Math.pow(1 + r, months);
            return (principal * r * power) / (power - 1);
        }

        // ========== VALIDATION ==========
        
        function validate(inputs) {
            const errors = [];
            const warnings = [];

            if (inputs.firstEmiDate <= inputs.loanStartDate) {
                errors.push('First EMI date must be after loan start date');
            }
            if (inputs.tenureYears <= 0) {
                errors.push('Tenure must be greater than 0');
            }
            if (inputs.loanAmount <= 0) {
                errors.push('Loan amount must be greater than 0');
            }
            if (inputs.annualRate <= 0) {
                errors.push('Interest rate must be greater than 0');
            }

            const loanEndDate = addMonths(inputs.firstEmiDate, inputs.tenureYears * 12 - 1);
            
            for (let event of inputs.rateChanges) {
                if (event.date < inputs.loanStartDate) {
                    errors.push(`Rate change date ${formatDate(event.date)} is before loan start date`);
                }
                if (event.date > loanEndDate) {
                    warnings.push(`Rate change date ${formatDate(event.date)} is after loan end date (will be ignored)`);
                }
            }

            for (let event of inputs.prepayments) {
                if (event.date < inputs.loanStartDate) {
                    warnings.push(`Prepayment date ${formatDate(event.date)} is before loan start date - will map to first EMI cycle`);
                }
                if (event.date > loanEndDate) {
                    warnings.push(`Prepayment date ${formatDate(event.date)} is after loan end date (will be ignored)`);
                }
            }

            return { errors, warnings };
        }

        // ========== AMORTIZATION ENGINE ==========
        
        function runAmortization(inputs, includeRateChanges, includePrepayments) {
            const totalMonths = inputs.tenureYears * 12;
            const maxMonths = totalMonths * 3;
            const calendar = buildEmiCalendar(inputs.loanStartDate, inputs.firstEmiDate, maxMonths);
            
            const rateChangesByCycle = {};
            const prepaymentsByCycle = {};
            
            if (includeRateChanges) {
                for (let rc of inputs.rateChanges) {
                    const cycle = mapEventToCycle(rc.date, calendar);
                    if (cycle !== null) {
                        rateChangesByCycle[cycle] = rc.rate;
                    }
                }
            }
            
            if (includePrepayments) {
                for (let pp of inputs.prepayments) {
                    const cycle = mapEventToCycle(pp.date, calendar);
                    if (cycle !== null) {
                        if (!prepaymentsByCycle[cycle]) {
                            prepaymentsByCycle[cycle] = [];
                        }
                        prepaymentsByCycle[cycle].push(pp);
                        console.log(`Mapped prepayment ${formatDate(pp.date)} to cycle ${cycle}`);
                    } else if (pp.date <= calendar[0].emiDate) {
                        // If prepayment is before first EMI, map it to cycle 1
                        if (!prepaymentsByCycle[1]) {
                            prepaymentsByCycle[1] = [];
                        }
                        prepaymentsByCycle[1].push(pp);
                        console.log(`Mapped early prepayment ${formatDate(pp.date)} to cycle 1`);
                    } else {
                        console.warn(`Could not map prepayment ${formatDate(pp.date)} to any cycle`);
                    }
                }
            }

            let balance = inputs.loanAmount;
            let rate = inputs.annualRate;
            let remainingMonths = totalMonths;
            let emi = calculateEmi(balance, rate, remainingMonths);
            const keepEmiSame = inputs.adjustmentMode === 'keep_emi';
            
            const schedule = [];
            let totalInterest = 0;
            let totalPrincipal = 0;
            let totalPrepaid = 0;
            let totalSimpleInterest = 0;
            
            for (let i = 0; i < maxMonths; i++) {
                if (balance <= 0.01) break;
                
                const cycle = calendar[i];
                
                // Apply rate changes
                if (rateChangesByCycle[cycle.index]) {
                    rate = rateChangesByCycle[cycle.index];
                    
                    if (!keepEmiSame) {
                        emi = calculateEmi(balance, rate, remainingMonths);
                    }
                }
                
                const monthlyRate = rate / 12 / 100;
                const interest = balance * monthlyRate;
                let principal = emi - interest;
                
                if (principal > balance) {
                    principal = balance;
                }
                
                balance -= principal;
                totalInterest += interest;
                totalPrincipal += principal;
                
                let prepaymentAmount = 0;
                let simpleInterest = 0;
                
                if (prepaymentsByCycle[cycle.index]) {
                    for (let pp of prepaymentsByCycle[cycle.index]) {
                        let amount = pp.amount;
                        if (amount > balance) {
                            amount = balance;
                        }
                        prepaymentAmount += amount;
                        simpleInterest += pp.simpleInterest || 0;
                    }
                    
                    balance -= prepaymentAmount;
                    totalPrepaid += prepaymentAmount;
                    totalSimpleInterest += simpleInterest;
                    
                    if (balance > 0 && !keepEmiSame) {
                        emi = calculateEmi(balance, rate, remainingMonths);
                    }
                }
                
                schedule.push({
                    cycle: cycle.index,
                    date: cycle.emiDate,
                    emi: emi,
                    interest: interest,
                    principal: principal,
                    prepayment: prepaymentAmount,
                    simpleInterest: simpleInterest,
                    balance: Math.max(0, balance),
                    rate: rate
                });
                
                remainingMonths--;
                
                if (balance <= 0.01) break;
            }
            
            return {
                schedule,
                totalInterest: totalInterest + totalSimpleInterest,
                totalPrincipal,
                totalPrepaid,
                totalSimpleInterest,
                finalEmi: emi,
                actualTenure: schedule.length
            };
        }

        // ========== INPUT PARSING ==========
        
        function parseInputs() {
            const loanStartDate = parseDate(document.getElementById('loanStartDate').value);
            const firstEmiDate = parseDate(document.getElementById('firstEmiDate').value);
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const annualRate = parseFloat(document.getElementById('annualRate').value);
            const tenureYears = parseInt(document.getElementById('tenureYears').value);
            const adjustmentMode = document.getElementById('adjustmentMode').value;
            
            const rateChanges = [];
            const rateChangesText = document.getElementById('rateChanges').value.trim();
            if (rateChangesText) {
                for (let line of rateChangesText.split('\n')) {
                    line = line.trim();
                    if (!line) continue;
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        rateChanges.push({
                            date: parseDate(parts[0].trim()),
                            rate: parseFloat(parts[1].trim())
                        });
                    }
                }
            }
            
            const prepayments = [];
            const prepaymentsText = document.getElementById('prepayments').value.trim();
            if (prepaymentsText) {
                for (let line of prepaymentsText.split('\n')) {
                    line = line.trim();
                    if (!line) continue;
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        prepayments.push({
                            date: parseDate(parts[0].trim()),
                            amount: parseFloat(parts[1].trim()),
                            simpleInterest: parts.length >= 3 ? parseFloat(parts[2].trim()) : 0
                        });
                    }
                }
            }
            
            return {
                loanStartDate,
                firstEmiDate,
                loanAmount,
                annualRate,
                tenureYears,
                adjustmentMode,
                rateChanges,
                prepayments
            };
        }

        // ========== VISUALIZATION ==========
        
        function drawChart(scenarios) {
            const canvas = document.getElementById('chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth * 2;
            const height = canvas.height = 800;
            
            ctx.clearRect(0, 0, width, height);
            
            let maxBalance = 0;
            let maxMonths = 0;
            for (let s of Object.values(scenarios)) {
                maxMonths = Math.max(maxMonths, s.schedule.length);
                for (let row of s.schedule) {
                    maxBalance = Math.max(maxBalance, row.balance);
                }
            }
            
            const padding = 80;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            ctx.fillStyle = '#333';
            ctx.font = '24px sans-serif';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const val = (maxBalance / 5) * i;
                const y = height - padding - (chartHeight / 5) * i;
                ctx.fillText((val / 100000).toFixed(0) + 'L', padding - 10, y + 8);
            }
            
            ctx.textAlign = 'center';
            const xAxisSteps = Math.min(10, Math.ceil(maxMonths / 12));
            for (let i = 0; i <= xAxisSteps; i++) {
                const val = Math.floor((maxMonths / xAxisSteps) * i);
                const x = padding + (chartWidth / xAxisSteps) * i;
                ctx.fillText(val, x, height - padding + 35);
            }
            
            ctx.save();
            ctx.translate(30, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText('Outstanding Balance', 0, 0);
            ctx.restore();
            
            ctx.textAlign = 'center';
            ctx.fillText('Month', width / 2, height - 20);
            
            const colors = {
                baseline: '#999',
                ratesOnly: '#FF9800',
                prepaymentsOnly: '#2196F3',
                combined: '#4CAF50'
            };
            
            const labels = {
                baseline: 'Baseline',
                ratesOnly: 'Rate Changes Only',
                prepaymentsOnly: 'Prepayments Only',
                combined: 'Combined'
            };
            
            // Draw lines - draw longer scenarios first so shorter ones are visible on top
            const sortedScenarios = Object.entries(scenarios).sort((a, b) => 
                b[1].schedule.length - a[1].schedule.length
            );
            
            for (let [key, scenario] of sortedScenarios) {
                ctx.strokeStyle = colors[key];
                ctx.lineWidth = scenario.schedule.length < maxMonths / 2 ? 4 : 2;
                ctx.beginPath();
                
                for (let i = 0; i < scenario.schedule.length; i++) {
                    const row = scenario.schedule[i];
                    const x = padding + (i / maxMonths) * chartWidth;
                    const y = height - padding - (row.balance / maxBalance) * chartHeight;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                // Draw line to zero if loan is paid off early
                if (scenario.schedule.length < maxMonths) {
                    const lastRow = scenario.schedule[scenario.schedule.length - 1];
                    const x = padding + (scenario.schedule.length / maxMonths) * chartWidth;
                    const y = height - padding;
                    ctx.lineTo(x, y);
                }
                
                ctx.stroke();
            }
            
            // Legend - show in reverse order so shorter scenarios are listed first
            let legendY = padding + 30;
            for (let [key, scenario] of Object.entries(scenarios)) {
                ctx.fillStyle = colors[key];
                ctx.fillRect(width - padding - 250, legendY - 12, 30, 4);
                ctx.fillStyle = '#333';
                ctx.font = '20px sans-serif';
                ctx.textAlign = 'left';
                const months = scenario.schedule.length;
                ctx.fillText(`${labels[key]} (${months}m)`, width - padding - 210, legendY);
                legendY += 35;
            }
        }

        // ========== DISPLAY RESULTS ==========
        
        function displayResults(scenarios, inputs) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('hidden');
            
            const baseline = scenarios.baseline;
            const combined = scenarios.combined;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let balanceToday = combined.schedule[0].balance + inputs.loanAmount;
            let monthsLeftFromToday = 0;
            let foundToday = false;
            
            for (let i = 0; i < combined.schedule.length; i++) {
                const row = combined.schedule[i];
                if (row.date >= today && !foundToday) {
                    foundToday = true;
                    monthsLeftFromToday = combined.schedule.length - i;
                    balanceToday = i > 0 ? combined.schedule[i - 1].balance : inputs.loanAmount;
                    break;
                }
            }
            
            if (!foundToday && today < inputs.loanStartDate) {
                balanceToday = inputs.loanAmount;
                monthsLeftFromToday = combined.actualTenure;
            }
            
            if (!foundToday && today > combined.schedule[combined.schedule.length - 1].date) {
                balanceToday = 0;
                monthsLeftFromToday = 0;
            }
            
            const interestSaved = baseline.totalInterest - combined.totalInterest;
            const tenureChange = combined.actualTenure - baseline.actualTenure;
            
            let html = '<h2>Results</h2>';
            
            html += '<div class="metrics">';
            html += `<div class="metric-card">
                <h3>Current Principal Balance</h3>
                <div class="metric-value">₹${(balanceToday / 100000).toFixed(2)}L</div>
                <div class="metric-sub">As of ${formatDate(today)}</div>
            </div>`;
            
            html += `<div class="metric-card">
                <h3>Time to Debt Free</h3>
                <div class="metric-value">${monthsLeftFromToday}</div>
                <div class="metric-sub">${(monthsLeftFromToday / 12).toFixed(1)} years from today</div>
            </div>`;
            
            html += `<div class="metric-card">
                <h3>Combined Total Interest</h3>
                <div class="metric-value">₹${(combined.totalInterest / 100000).toFixed(2)}L</div>
                <div class="metric-sub">${combined.actualTenure} months total</div>
            </div>`;
            
            html += `<div class="metric-card">
                <h3>Interest ${interestSaved >= 0 ? 'Saved' : 'Increased'}</h3>
                <div class="metric-value">₹${(Math.abs(interestSaved) / 100000).toFixed(2)}L</div>
                <div class="metric-sub ${interestSaved < 0 ? 'negative' : ''}">${interestSaved >= 0 ? '' : '+'} ${((interestSaved / baseline.totalInterest) * 100).toFixed(1)}% vs baseline</div>
            </div>`;
            
            html += `<div class="metric-card">
                <h3>Baseline Total Interest</h3>
                <div class="metric-value">₹${(baseline.totalInterest / 100000).toFixed(2)}L</div>
                <div class="metric-sub">${baseline.actualTenure} months total</div>
            </div>`;
            
            html += `<div class="metric-card">
                <h3>Tenure ${tenureChange > 0 ? 'Increase' : 'Change'}</h3>
                <div class="metric-value">${tenureChange > 0 ? '+' : ''}${tenureChange}</div>
                <div class="metric-sub ${tenureChange > 0 ? 'negative' : ''}">${tenureChange > 0 ? '+' : ''}${(tenureChange / 12).toFixed(1)} years vs baseline</div>
            </div>`;
            html += '</div>';
            
            html += '<canvas id="chart"></canvas>';
            
            html += '<div class="download-section">';
            html += '<h3>Export Analysis</h3>';
            html += '<button class="secondary" onclick="downloadXLSX()">Download Excel (XLSX)</button>';
            html += '<button class="secondary" onclick="downloadCSV()">Download CSVs (ZIP)</button>';
            /*html += '<button class="secondary" onclick="downloadPDF()">Download PDF</button>';*/
            html += '</div>';
            
            html += '<div class="toggle-section">';
            html += '<h3>Amortization Schedule</h3>';
            html += '<div class="scenario-selector">';
            html += '<button class="scenario-btn active" onclick="showScenarioTable(\'baseline\')">Baseline</button>';
            html += '<button class="scenario-btn" onclick="showScenarioTable(\'ratesOnly\')">Rate Changes Only</button>';
            html += '<button class="scenario-btn" onclick="showScenarioTable(\'prepaymentsOnly\')">Prepayments Only</button>';
            html += '<button class="scenario-btn" onclick="showScenarioTable(\'combined\')">Combined</button>';
            html += '</div>';
            html += '<div id="tableContainer" class="table-container"></div>';
            html += '</div>';
            
            resultsDiv.innerHTML = html;
            
            drawChart(scenarios);
            showScenarioTable('baseline');
        }

        // ========== TABLE DISPLAY ==========
        
        window.showScenarioTable = function(scenarioKey) {
            const buttons = document.querySelectorAll('.scenario-btn');
            buttons.forEach((btn) => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const scenarios = window.lastScenarios;
            const scenario = scenarios[scenarioKey];
            
            const labels = {
                baseline: 'Baseline',
                ratesOnly: 'Rate Changes Only',
                prepaymentsOnly: 'Prepayments Only',
                combined: 'Combined'
            };
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let totalEmi = 0;
            let totalInterest = 0;
            let totalPrincipal = 0;
            let totalPrepayment = 0;
            let totalSimpleInterest = 0;
            
            for (let row of scenario.schedule) {
                totalEmi += row.emi;
                totalInterest += row.interest;
                totalPrincipal += row.principal;
                totalPrepayment += row.prepayment;
                totalSimpleInterest += row.simpleInterest;
            }
            
            let html = `<h3>${labels[scenarioKey]} Scenario</h3>`;
            html += '<table><thead><tr>';
            html += '<th>Month</th><th>Date</th><th>EMI</th><th>Interest</th>';
            html += '<th>Principal</th><th>Prepayment</th><th>Simple Int</th><th>Balance</th><th>Rate %</th>';
            html += '</tr></thead><tbody>';
            
            let currentFY = '';
            for (let i = 0; i < scenario.schedule.length; i++) {
                const row = scenario.schedule[i];
                const fy = getFinancialYear(row.date);
                
                // Insert FY header row
                if (fy !== currentFY) {
                    html += `<tr class="fy-header"><td colspan="9">${fy}</td></tr>`;
                    currentFY = fy;
                }
                
                // Check if this is current month
                const isCurrentMonth = isSameMonth(row.date, today);
                const rowClass = isCurrentMonth ? 'current-month' : (i % 2 === 0 ? 'fy-band' : '');
                
                html += `<tr class="${rowClass}">`;
                html += `<td>${row.cycle}</td>`;
                html += `<td>${formatDate(row.date)}</td>`;
                html += `<td>₹${row.emi.toFixed(0)}</td>`;
                html += `<td>₹${row.interest.toFixed(0)}</td>`;
                html += `<td>₹${row.principal.toFixed(0)}</td>`;
                html += `<td>${row.prepayment > 0 ? '₹' + row.prepayment.toFixed(0) : '-'}</td>`;
                html += `<td>${row.simpleInterest > 0 ? '₹' + row.simpleInterest.toFixed(0) : '-'}</td>`;
                html += `<td>₹${row.balance.toFixed(0)}</td>`;
                html += `<td>${row.rate.toFixed(2)}</td>`;
                html += '</tr>';
            }
            
            html += '<tr style="background: #f0f0f0; font-weight: bold; border-top: 2px solid #333;">';
            html += `<td colspan="2">TOTAL</td>`;
            html += `<td>₹${totalEmi.toFixed(0)}</td>`;
            html += `<td>₹${totalInterest.toFixed(0)}</td>`;
            html += `<td>₹${totalPrincipal.toFixed(0)}</td>`;
            html += `<td>₹${totalPrepayment.toFixed(0)}</td>`;
            html += `<td>₹${totalSimpleInterest.toFixed(0)}</td>`;
            html += `<td colspan="2">-</td>`;
            html += '</tr>';
            
            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        };

        // ========== EXPORT FUNCTIONS ==========
        
        window.downloadXLSX = function() {
            const wb = XLSX.utils.book_new();
            const scenarios = window.lastScenarios;
            
            const scenarioNames = {
                baseline: 'Baseline',
                ratesOnly: 'Rate Changes Only',
                prepaymentsOnly: 'Prepayments Only',
                combined: 'Combined'
            };
            
            for (let [key, scenario] of Object.entries(scenarios)) {
                const data = [];
                data.push(['Month', 'Date', 'EMI', 'Interest', 'Principal', 'Prepayment', 'Simple Interest', 'Balance', 'Rate %']);
                
                for (let row of scenario.schedule) {
                    data.push([
                        row.cycle,
                        formatDate(row.date),
                        row.emi,
                        row.interest,
                        row.principal,
                        row.prepayment,
                        row.simpleInterest,
                        row.balance,
                        row.rate
                    ]);
                }
                
                // Add total row
                const totalEmi = scenario.schedule.reduce((sum, r) => sum + r.emi, 0);
                const totalInterest = scenario.schedule.reduce((sum, r) => sum + r.interest, 0);
                const totalPrincipal = scenario.schedule.reduce((sum, r) => sum + r.principal, 0);
                const totalPrepayment = scenario.schedule.reduce((sum, r) => sum + r.prepayment, 0);
                const totalSimpleInterest = scenario.schedule.reduce((sum, r) => sum + r.simpleInterest, 0);
                
                data.push(['TOTAL', '', totalEmi, totalInterest, totalPrincipal, totalPrepayment, totalSimpleInterest, '', '']);
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, scenarioNames[key].substring(0, 31));
            }
            
            XLSX.writeFile(wb, 'Loan_Amortization_Analysis.xlsx');
        };
        
        window.downloadCSV = function() {
            const scenarios = window.lastScenarios;
            const scenarioNames = {
                baseline: 'Baseline',
                ratesOnly: 'Rate_Changes_Only',
                prepaymentsOnly: 'Prepayments_Only',
                combined: 'Combined'
            };
            
            for (let [key, scenario] of Object.entries(scenarios)) {
                let csv = 'Month,Date,EMI,Interest,Principal,Prepayment,Simple Interest,Balance,Rate %\n';
                
                for (let row of scenario.schedule) {
                    csv += `${row.cycle},${formatDate(row.date)},${row.emi.toFixed(2)},${row.interest.toFixed(2)},${row.principal.toFixed(2)},${row.prepayment.toFixed(2)},${row.simpleInterest.toFixed(2)},${row.balance.toFixed(2)},${row.rate}\n`;
                }
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Loan_Amortization_${scenarioNames[key]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }
        };
        
        window.downloadPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('Loan Amortization Analysis', 20, 20);
            
            const scenarios = window.lastScenarios;
            const inputs = window.lastInputs;
            
            doc.setFontSize(12);
            doc.text(`Loan Amount: ₹${inputs.loanAmount.toLocaleString()}`, 20, 35);
            doc.text(`Interest Rate: ${inputs.annualRate}%`, 20, 42);
            doc.text(`Tenure: ${inputs.tenureYears} years`, 20, 49);
            doc.text(`Adjustment Mode: ${inputs.adjustmentMode === 'keep_emi' ? 'Keep EMI Same' : 'Recalculate EMI'}`, 20, 56);
            
            let yPos = 70;
            
            const scenarioNames = {
                baseline: 'Baseline',
                ratesOnly: 'Rate Changes Only',
                prepaymentsOnly: 'Prepayments Only',
                combined: 'Combined'
            };
            
            for (let [key, scenario] of Object.entries(scenarios)) {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(14);
                doc.text(scenarioNames[key], 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.text(`Total Interest: ₹${(scenario.totalInterest / 100000).toFixed(2)}L`, 20, yPos);
                doc.text(`Tenure: ${scenario.actualTenure} months`, 120, yPos);
                yPos += 7;
                doc.text(`Total Prepaid: ₹${(scenario.totalPrepaid / 100000).toFixed(2)}L`, 20, yPos);
                doc.text(`Simple Interest: ₹${(scenario.totalSimpleInterest / 100000).toFixed(2)}L`, 120, yPos);
                yPos += 15;
            }
            
            doc.save('Loan_Amortization_Analysis.pdf');
        };

        // ========== MAIN CALCULATE ==========
        
        function calculate() {
            try {
                document.getElementById('errors').innerHTML = '';
                document.getElementById('warnings').innerHTML = '';
                document.getElementById('results').classList.add('hidden');
                
                const inputs = parseInputs();
                const validation = validate(inputs);
                
                if (validation.errors.length > 0) {
                    let html = '<div class="error"><strong>Errors:</strong><ul>';
                    for (let err of validation.errors) {
                        html += `<li>${err}</li>`;
                    }
                    html += '</ul></div>';
                    document.getElementById('errors').innerHTML = html;
                    return;
                }
                
                if (validation.warnings.length > 0) {
                    let html = '<div class="warning"><strong>Warnings:</strong><ul>';
                    for (let warn of validation.warnings) {
                        html += `<li>${warn}</li>`;
                    }
                    html += '</ul></div>';
                    document.getElementById('warnings').innerHTML = html;
                }
                
                const scenarios = {
                    baseline: runAmortization(inputs, false, false),
                    ratesOnly: runAmortization(inputs, true, false),
                    prepaymentsOnly: runAmortization(inputs, false, true),
                    combined: runAmortization(inputs, true, true)
                };
                
                window.lastScenarios = scenarios;
                window.lastInputs = inputs;
                
                displayResults(scenarios, inputs);
                
            } catch (error) {
                document.getElementById('errors').innerHTML = 
                    `<div class="error"><strong>Error:</strong> ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>